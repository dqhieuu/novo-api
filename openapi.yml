openapi: 3.0.2
info:
  title: Novo App
  version: '1.0'
  description: >-
    A book server that serves all kinds of books (novels, comics, manga and
    whatnots)
  contact: {}
servers:
  - url: 'http://localhost:7001'
paths:
  '/oauth/{provider}':
    get:
      summary: OAuth login initialize
      description: Redirects client to OAuth provider page for 3-legged authentication.
      responses:
        '302':
          description: Redirect to the provider page
        '404':
          description: Provider not found
      tags:
        - Users
      parameters: []
      operationId: goToOauthProvider
      security: []
      
  /login:
    post:
      summary: Password login
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [username, password]
              properties:
                usernameOrEmail:
                  type: string
                  example: Người dùng X
                  minLength: 6
                password:
                  $ref: '#/components/schemas/Password'
      responses:
        '200':
          description: Successful login
        '401':
          description: Invalid credentials
      tags:
        - Users
      parameters: []
      operationId: loginByOauthCode
    get:
      summary: Oauth login
      description: >
        Client goes to this page after having received the oauth code from
        provider (Google). It's performed automatically.
      parameters:
        - name: provider
          in: path
          required: true
          description: The provider of the OAuth service.
          schema:
            type: string
            enum:
              - google
        - name: code
          in: path
          required: true
          description: >
            Code received after the client has successfully been verified by the OAuth
            provider side. (Embedded in the redirect link)
          schema:
            type: string
      responses:
        '200':
          description: Login success
        '401':
          description: Invalid credentials
        '404':
          description: Provider not found
      tags:
        - Users
      operationId: loginByPassword
  /book:
    post:
      summary: Create a new book group
      description: Create a new book group by json request body.
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - description
              properties:
                name:
                  type: string
                  example: One punch Man
                  description: The name of this book group
                description:
                  type: string
                  example: The story of a hero named Saitama.
                authors:
                  type: array
                  example: [123, 124, 125]
                  description: Author IDs from the database
                  items: 
                    type: integer
                cover_arts:
                  type: array
                  example: [123, 124, 125]
                  description: Image IDs from the database. The first will be selected as the cover thumbnail.
                  items: 
                    type: integer
      responses:
        200:
          description: Created a new book group successfully
        403:
          description: User not authorized
      tags: [Book Groups]
  /book/{bookGroupId}:
    delete:
      summary: Delete a book group
      description: Delete a book group by its id. Will delete all containing book chapters.
      parameters:
        - name: bookGroupId
          in: path
          required: true
          schema:
            type: integer
      responses:
        200:
          description: Deleted OK
        403:
          description: User not authorized
        404:
          description: Book group not found
      tags:
        - Book Groups

  '/search-suggest/{query}':
    get:
      summary: Search suggestion
      description: Suggestion when typing text in the search box.
      parameters:
        - name: query
          in: path
          required: true
          schema:
            type: string
            example: solo lev
            maxLength: 100

      responses:
        '200':
          description: A list of book may contain 0 elements
          content:
            application/json:
              schema:
                type: object
                properties:
                  books:
                    type: array
                    description: A suggestion list of books when searching.
                    items:
                      type: object
                      properties:
                        thumbnail:
                          description: A small-sized thumbnail
                          type: string
                          example: anh.jpg
                        title:
                          type: string
                          description: Book title
                          example: Boku no pico
                        latestChapter:
                          type: number
                          description: The highest number chapter
                          example: 16.5
      tags:
        - Book Groups
      operationId: searchSuggestion
  '/search/{query}':
    get:
      summary: Search result
      description: Result page containing book groups after hitting enter.
      parameters:
        - name: query
          in: path
          required: true
          schema:
            type: string
            example: solo leveling
        - name: page
          in: query
          required: false
          schema:
            type: integer
            default: 1
          description: May clamp to first/last page for better ux (page <= 0, page = 9999)
      operationId: getSearchResult
      responses:
        200:
          description: Query success
          content:
            application/json:
              schema:
                type: object
                properties:
                  lastPage:
                    type: integer
                    description: The last page number for pagination purposes
                    example: 15
                  books:
                    type: array
                    description: Books in a dedicated search page
                       have more information than when searching.
                    items:
                      type: object
                      properties:
                        thumbnail:
                          description: A medium-sized thumbnail
                          type: string
                          example: anh.jpg
                        title:
                          type: string
                          example: Boku no pico
                        latestChapter:
                          type: number
                          example: 16.5
                        comments:
                          description: Number of comments
                          type: integer
                          example: 105
                        views:
                          description: Number of views
                          type: integer
                          example: 15324
                        likes:
                          description: The result of likes minus dislikes.
                          type: integer
                          example: 24
      tags:
        - Book Groups
  '/chapter/{chapterId}':
    get:
      summary: Get chapter page content
      description: |-
        All necessary content for displaying a chapter page.
        There are links to the previous and next chapter
      parameters:
        - name: chapterId
          in: path
          required: true
          schema:
            type: string
          description: Id of a chapter from the database
      operationId: getChapterByChapterId
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      type:
                        type: string
                        example: images
                        enum:
                          - images
                      images:
                        type: array
                        description: A list of image urls
                        items:
                          type: string
                      nextChapter:
                        description: Url to the next chapter
                        type: string
                      prevChapter:
                        description: Url to the previous chapter
                        type: string
                    required:
                      - type
                      - images
                  - type: object
                    required:
                      - type
                      - textContent
                    properties:
                      type:
                        type: string
                        example: hypertext
                        enum:
                          - hypertext
                      textContent:
                        type: string
                        example: Call me Ishmael. Some years ago...
                        description: The content for a text chapter (may contain markdown formattting)
                      nextChapter:
                        description: Url to the next chapter
                        type: string
                      prevChapter:
                        description: Url to the previous chapter
                        type: string
        404:
          description: Chapter not found
      security: []
      tags:
        - Book Chapters
    delete:
      summary: Delete a book chapter
      description: ''
      parameters:
        - name: chapterId
          in: path
          schema:
            type: number
          required: true
      operationId: deleteChapterByChapterId
      responses:
        '200':
          description: Deleted successfully
        '403':
          description: Forbidden
        '404':
          description: Can't find book chapter
      tags:
        - Book Chapters
    # patch:
    #   summary: Update book chapter content
    #   description: ''
    #   parameters: []
    #   operationId: updateChapterByChapterId
    #   responses:
    #     default:
    #       description: Default response
    #   tags:
    #     - Book Chapters
  /chapter/:
    post:
      summary: Post a new chapter
      description: A new book chapter to be posted, must belong to a book group.
      parameters: []
      operationId: postNewChapter
      responses:
        301:
          description: New chapter created. Redirect to the chapter
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - type: object
                  required:
                    - bookGroupId
                    - chapterNumber
                    - type
                    - textContent
                  properties:
                    bookGroupId:
                      type: integer
                      example: 25
                    chapterNumber:
                      type: number
                      example: 6.8
                    type:
                      type: string
                      enum: [hypertext]
                    textContent:
                      description: The hypertext content of the chapter.
                      type: string
                      example: "Some book content. Once upon..."
                - type: object
                  required:
                    - bookGroupId
                    - chapterNumber
                    - type
                    - images
                  properties:
                    bookGroupId:
                      type: integer
                      example: 25
                    chapterNumber:
                      type: number
                      example: 6.8
                    type:
                      type: string
                      enum: [images]
                    images:
                      description: IDs of images after uploaded to the server.
                      type: array
                      items:
                        type: integer
      tags:
        - Book Chapters
  '/like/{bookGroupId}':
    get:
      summary: Get like count of a book group
      description: This gets the like and dislike count of a book group
      parameters:
        - name: bookGroupId
          in: path
          required: true
          schema:
            type: integer
      operationId: getLikeAndDislikeCountByBookGroupId
      responses:
        200:
          description: Successful get
          content:
            application/json:
              schema:
                type: object
                required:
                  - like_count
                  - dislike_count
                properties:
                  like_count:
                    type: integer
                    example: 3
                  dislike_count:
                    type: integer
                    example: 0
        404:
          description: Book group not found


      tags:
        - Book Groups
  '/like/{bookGroupId}/{operation}':
    post:
      summary: Like operations on a book group
      description: Like/dislike/or unlike operation by a user for a book group
      parameters:
        - name: bookGroupId
          in: path
          required: true
          schema:
            type: integer
        - name: operation
          in: path
          required: true
          schema:
            enum: [like, dislike, unlike]
            example: like
            type: string
      operationId: likeOperationsForBookGroup
      responses:
        default:
          description: Default response
      tags:
        - Book Groups
  /comments/{bookId}:
    get:
      summary: Get comments from a book group
      description: >-
        Contains all comments from chapters in this group and all chapter
        unspecified comments
      parameters: []
      operationId: getCommentsByBookGroupId
      responses:
        200:
          description: OK

      tags:
        - Book Comments
    post:
      summary: Post a comment in a book group
      description: Create a comment that isn't chapter specific
      parameters: []
      operationId: postCommentByBookGroupId
      responses:
        default:
          description: Default response
      tags:
        - Book Comments
  /comments:
    delete:
      summary: Delete a book comment
      description: Doesn't need a specific book group. Id is global among all groups
      parameters: []
      operationId: deleteCommentById
      responses:
        default:
          description: Default response
      tags:
        - Book Comments
    patch:
      summary: Update a book comment
      description: Doesn't need a specific book group. Id is global among all groups
      parameters: []
      operationId: updateCommentById
      responses:
        default:
          description: Default response
      tags:
        - Book Comments
  '/comment/{bookGroupId}':
    get:
      summary: Get comments from a book chapter
      description: ''
      parameters: []
      operationId: getCommentsByChapterId
      responses:
        '200':
          description: Default response
          content:
            application/json:
              schema: {}
      tags:
        - Book Comments
      security: []
    post:
      summary: Post a comment to a book chapter
      description: ''
      parameters: []
      operationId: postCommentByChapterId
      responses:
        default:
          description: Default response
      tags:
        - Book Comments
  /register:
    post:
      summary: Register a new user (password)
      description: Register a new user with password, username, and email. An alternative workflow 
        is that user signs up/logs in with their account from an OAuth provider.
      parameters: []
      operationId: registerANewUser
      responses:
        default:
          description: Default response
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                username:
                  type: string
                  description: Must be at least 6 characters, not starting with a space, may contain at most 1 white spaces between characters, may contain special characters except control characters and line break characters. 
                  example: Người dùng W1B00 ／人 ◕ ‿‿ ◕ 人＼
                email:
                  type: string
                  example: example@example.com
                  description: Standards compliant.
                password:
                  type: string
                  description: Must be at least 8 characters
                  example: A!B2Ce%%
              required: [username, email, password]
      tags:
        - Users
  /complete-oauth-register:
    post:
      summary: Complete OAuth registration
      description: >-
        User type in the username and maybe change their default profile picture
        to complete registration
      parameters: []
      operationId: completeOauthRegister
      responses:
        200:
          description: OAuth user account officially created
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
              properties:
                username:
                  $ref: '#/components/schemas/Username'
                avatar:
                  type: integer
                  description: An image id from the database
      tags:
        - Users
  '/user/{userId}':
    get:
      summary: Get public user info
      description: 'Get public user info (i.e., username, books posted, profile, avatar )'
      parameters: []
      operationId: getUserInfoById
      responses:
        200:
          description: Found user
          content:
            application/json:
              schema:
                type: object
                required:
                  - name
                  - role
                  - books_posted
                properties:
                  name:
                    type: string
                    example: Người dùng ABC
                  role:
                    $ref: '#/components/schemas/UserRole'
                  avatar:
                    type: string
                    description: Url of avatar
                  description:
                    type: string
                    example: Mô tả người dùng...
                  books_posted:
                    type: array
                    items:
                      $ref: '#/components/schemas/BookItem'
      tags:
        - Users
  '/author/{authorId}':
    get:
      summary: Get an author page
      description: 'A complete author page, with books from author'
      parameters:
        - name: authorId
          in: path
          required: true
          schema:
            type: integer
      operationId: getAuthorById
      responses:
        200:
          description: Successful request
          content:
            application/json:
              schema:
                type: object
                required:
                  - name
                properties:
                  name:
                    type: string
                    example: George R.R. Washington
                  description:
                    type: string
                    example: A novelist who wrote the script for the famous movie, The Ring.
                  avatar:
                    type: string
                    description: The url of his avatar. Large-sized.
                  books:
                    type: array
                    items:
                      $ref: '#/components/schemas/BookItem'

        403:
          description: User not authorized
        404:
          description: Author not found
                  

      tags:
        - Book Authors
    patch:
      summary: Update an author
      description: 'Update author biography, name, aliases'
      parameters: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                description:
                  type: string
                  example: Some modified author description.
                avatar:
                  type: integer
                  description: The image id in the database.
      operationId: updateAuthorById
      responses:
        200:
          description: Updated successfully
        403:
          description: User not authorized
        404:
          description: Author not found
        409:
          description: Conflict when updating author
      tags:
        - Book Authors
    delete:
      summary: Delete an author
      description: Delete an author by id
      parameters:
        - name: authorId
          in: path
          required: true
          schema:
            type: integer

      operationId: deleteAuthorById
      responses:
        200:
          description: Deleted successfully
        403:
          description: User not authorized
        404:
          description: Author not found
        
      tags:
        - Book Authors
  '/author':
    post:
      summary: Create a new author
      description: 'A complete author page, with books from author'
      parameters: []
      operationId: createAuthor
      responses:
        200:
          description: Created successfully
        403:
          description: User not authorized
        409:
          description: Author already exists
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
                  maxLength: 30
                  example: Aldous Huxley
                description:
                  type: string
                  maxLength: 500
                  example: Something about his biography.
                avatarId:
                  description: The image id in the database
                  type: integer
                  example: 10533
                  
      tags:
        - Book Authors
tags:
  - name: Users
    description: For all user related operations.
  - name: Book Groups
    description: Representing folders for book chapters (can also be called book titles).
  - name: Book Chapters
    description: May hold hypertext content or images
  - name: Book Comments
    description: User comments on book groups or book chapters
  - name: Book Authors
    description: People who write books (one book may have multiple authors)
  - name: Images 
    description: Functions for uploading, querying image
components:
  securitySchemes:
    cookieAuth:
      type: apiKey
      in: cookie
      name: jwt
  links: {}
  callbacks: {}
  schemas:
    Username:
      type: string
      minLength: 6
      maxLength: 20
      example: Ngdùng W1Bu ／人 ◕ ‿‿ ◕ 人＼
    Password:
      type: string
      minLength: 8
      maxLength: 50
      example: t3stPAS!dảk
    UserRole:
      type: string
      example: member
      enum: [member, moderator, admin]
    RolePermissions:
      type: array
      example: [comment.read, author.read]
      enum: [comment.read, comment.post, comment.modify, 
        comment.modifySelf, comment.deleteSelf, comment.delete,
        book.read, book.post, book.modifySelf, 
        book.modify, book.deleteSelf, book.delete,
        chapter.read, chapter.post, chapter.modifySelf, 
        chapter.modify, chapter.deleteSelf, chapter.delete
        author.read, author.post, author.modify, author.delete
        user.readSelf, user.read, userPrivate.read
        ]
    BookItem:
      type: object
      required:
        - title
        - url
        - thumbnail
      properties:
        title:
          type: string
          example: TLOTR
        url:
          type: string
          example: /chapter/10003
        thumbnail:
          description: The url of the book thumbnail. Middle-sized.
          type: string
          example: /image/book/s/25-232321-1231.jpg

security:
  - cookieAuth: []